<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if title == site_title %}{{ title }}{% else %}{{ title }} — {{ site_title }}{% endif %}</title>
  <meta name="description" content="{{ description }}">
  <meta name="author" content="{{ site_author }}">
  <meta name="monowiki-base-url" content="{{ base_url }}">
  <meta name="monowiki-note-slug" content="{{ slug }}">
  {% match date %}{% when Some with (d) %}<meta name="date" content="{{ d }}">{% when None %}{% endmatch %}
  <link rel="stylesheet" href="{{ css_path }}css/reset.css">
  <link rel="stylesheet" href="{{ css_path }}css/style.css">
  <link rel="stylesheet" href="{{ css_path }}css/previews.css">
  <link rel="stylesheet" href="{{ css_path }}css/graph.css">
  <link rel="stylesheet" href="{{ css_path }}css/search.css">

  <!-- Frontend bundle -->
  <script type="module" src="{{ css_path }}js/bundle.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <nav class="nav">
        <a href="{{ nav_home }}">home</a>
        {% if has_about %}<a href="{{ nav_about }}">about</a>{% endif %}
        {% if has_github %}<a href="{{ nav_github }}">github</a>{% endif %}
        <button id="search-trigger" class="search-trigger" aria-label="Search">
          <span class="search-trigger-text">search</span>
          <span class="search-trigger-hint">⌘K</span>
        </button>
      </nav>
    </div>
  </header>

  <main>
    <article>
      {% match date %}
        {% when Some with (d) %}
        <p>
          <em>Published: {{ d }}</em>
          {% match updated %}{% when Some with (upd) %}<em> • Updated: {{ upd }}</em>{% when None %}{% endmatch %}
        </p>
        {% when None %}
      {% endmatch %}

      {% if tags.len() > 0 %}
      <p>
        Tags: {% for tag in tags %}<code>{{ tag }}</code> {% endfor %}
      </p>
      {% endif %}

      {% match toc_html %}
        {% when Some with (toc) %}
        <div id="toc" class="toc-container">
          {{ toc|safe }}
        </div>
        {% when None %}
      {% endmatch %}

      <div class="page-subheader">
        {% match source %}
          {% when Some with (_) %}
          <button id="copy-page-source" class="copy-page-btn" type="button" aria-label="Copy page Markdown">Copy page source</button>
          {% when None %}
        {% endmatch %}
        <button id="global-graph-toggle" class="graph-btn" type="button" aria-label="Open graph">Graph</button>
      </div>

      {{ content|safe }}

      {% if backlinks.len() > 0 %}
      <hr>
      <div id="backlinks">
        <h3>Backlinks</h3>
        <ul class="backlinks-list">
          {% for backlink in backlinks %}
          <li><a href="{{ backlink.url }}">{{ backlink.title }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </article>

    {% if slug != "index" %}
    <hr>

    <p>
      <a href="{{ nav_home }}">← Back to home</a>
    </p>
    {% endif %}
    </article>

  </main>

{% if comments.len() > 0 %}
<style>
  {% for comment in comments %}
    {% if comment.has_anchor && comment.depth == 0 %}
      #{{ comment.resolved_anchor }} {
        background: {{ comment.color_bg }};
        box-shadow: inset 0 -2px 0 {{ comment.color_border }};
        transition: background 0.2s ease;
        cursor: pointer;
      }
      #{{ comment.resolved_anchor }}:hover {
        filter: brightness(0.95);
      }
    {% endif %}
  {% endfor %}
</style>

{% for comment in comments %}
{% if comment.depth == 0 && comment.has_anchor %}
<div
  class="comment-modal {% if comment.resolved %}resolved{% else %}open{% endif %}"
  id="comment-modal-{{ comment.id }}"
  style="background: {{ comment.color_bg }}; border-color: {{ comment.color_border }}"
  data-anchor="{{ comment.resolved_anchor }}"
  data-thread-root="{{ comment.thread_root }}"
>
  <div class="comment-thread">
    <div class="comment-entry depth-0" id="comment-{{ comment.id }}">
      <div class="comment-meta">
        <span class="comment-status">{{ comment.status }}</span>
        {% if comment.has_author %}<span class="comment-author">{{ comment.author }}</span>{% endif %}
      </div>
      <div class="comment-body">{{ comment.body_html | safe }}</div>
      {% if comment.has_quote %}
      <div class="comment-quote">"{{ comment.quote }}"</div>
      {% endif %}
    </div>
    {% for reply in comments %}
    {% if reply.thread_root == comment.id && reply.depth > 0 %}
    <div class="comment-entry depth-{{ reply.depth }}" id="comment-{{ reply.id }}" style="margin-left: {{ reply.depth }}ch;">
      <div class="comment-meta">
        <span class="comment-reply-marker">↳</span>
        <span class="comment-status">{{ reply.status }}</span>
        {% if reply.has_author %}<span class="comment-author">{{ reply.author }}</span>{% endif %}
      </div>
      <div class="comment-body">{{ reply.body_html | safe }}</div>
      {% if reply.has_quote %}
      <div class="comment-quote">"{{ reply.quote }}"</div>
      {% endif %}
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}
{% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modals = Array.from(document.querySelectorAll('.comment-modal'));

    modals.forEach((modal) => {
      const anchor = modal.dataset.anchor;
      if (!anchor) return;
      const target = document.getElementById(anchor);
      if (!target) return;

      let hideTimeout;

      const showModal = (e) => {
        clearTimeout(hideTimeout);
        // Hide all other modals
        modals.forEach(m => m.classList.remove('visible'));

        // Position the modal near the target
        const rect = target.getBoundingClientRect();
        const scrollTop = window.scrollY;
        const scrollLeft = window.scrollX;

        modal.style.top = (rect.bottom + scrollTop + 8) + 'px';
        modal.style.left = (rect.left + scrollLeft) + 'px';

        modal.classList.add('visible');

        // Adjust if modal goes off-screen right
        requestAnimationFrame(() => {
          const modalRect = modal.getBoundingClientRect();
          if (modalRect.right > window.innerWidth - 16) {
            modal.style.left = (window.innerWidth - modalRect.width - 16 + scrollLeft) + 'px';
          }
          // Adjust if modal goes off-screen bottom
          if (modalRect.bottom > window.innerHeight) {
            modal.style.top = (rect.top + scrollTop - modalRect.height - 8) + 'px';
          }
        });
      };

      const hideModal = () => {
        hideTimeout = setTimeout(() => {
          modal.classList.remove('visible');
        }, 50);
      };

      target.addEventListener('mouseenter', showModal);
      target.addEventListener('mouseleave', hideModal);
      modal.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
      modal.addEventListener('mouseleave', hideModal);
    });
  });
</script>

{% if has_unanchored_comments %}
{# Render unanchored/unresolved comments in a visible section #}
<div class="unanchored-comments" id="unanchored-comments-section">
  <h3 class="unanchored-comments-heading">Unanchored Comments</h3>
  {% for comment in comments %}
  {% if comment.depth == 0 && !comment.has_anchor %}
  <div
    class="comment-block {% if comment.resolved %}resolved{% else %}open{% endif %}"
    id="comment-{{ comment.id }}"
    style="background: {{ comment.color_bg }}; border-color: {{ comment.color_border }}"
  >
    <div class="comment-thread">
      <div class="comment-entry depth-0">
        <div class="comment-meta">
          <span class="comment-status">{{ comment.status }}</span>
          {% if comment.has_author %}<span class="comment-author">{{ comment.author }}</span>{% endif %}
          <span class="comment-unanchored-badge">unanchored</span>
        </div>
        <div class="comment-body">{{ comment.body_html | safe }}</div>
        {% if comment.has_quote %}
        <div class="comment-quote">"{{ comment.quote }}"</div>
        {% endif %}
      </div>
      {% for reply in comments %}
      {% if reply.thread_root == comment.id && reply.depth > 0 %}
      <div class="comment-entry depth-{{ reply.depth }}" style="margin-left: {{ reply.depth }}ch;">
        <div class="comment-meta">
          <span class="comment-reply-marker">↳</span>
          <span class="comment-status">{{ reply.status }}</span>
          {% if reply.has_author %}<span class="comment-author">{{ reply.author }}</span>{% endif %}
        </div>
        <div class="comment-body">{{ reply.body_html | safe }}</div>
        {% if reply.has_quote %}
        <div class="comment-quote">"{{ reply.quote }}"</div>
        {% endif %}
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {% endfor %}
</div>
{% endif %}
{% endif %}

  <!-- Global Graph Modal -->
  <div class="global-graph-outer" id="global-graph-outer">
    <div class="global-graph-container" id="global-graph-container"></div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal">
    <div class="search-modal-wrapper">
      <div class="search-modal-header">
        <input
          type="text"
          id="search-modal-input"
          class="search-modal-input"
          placeholder="Search documentation..."
          autocomplete="off"
        />
      </div>
      <div class="search-modal-tabs">
        <button class="search-tab active" data-tab="results">Results</button>
        <button class="search-tab" data-tab="graph">Graph</button>
      </div>
      <div class="search-modal-content">
        <div class="search-tab-panel active" id="search-tab-results">
          <div class="search-modal-results" id="search-modal-results"></div>
        </div>
        <div class="search-tab-panel" id="search-tab-graph">
          <div class="search-graph-container" id="search-graph-container"></div>
        </div>
      </div>
      <div class="search-modal-footer">
        <div class="search-hint">
          <span><kbd>↑</kbd><kbd>↓</kbd> Navigate</span>
          <span><kbd>↵</kbd> Select</span>
          <span><kbd>ESC</kbd> Close</span>
        </div>
        <div class="search-count"></div>
      </div>
    </div>
  </div>

  {% match source %}
    {% when Some with (src) %}
    <script id="page-source-data" type="application/json">{{ src|json|safe }}</script>
    {% when None %}
  {% endmatch %}

</body>
</html>
