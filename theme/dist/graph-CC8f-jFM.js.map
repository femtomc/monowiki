{"version":3,"file":"graph-CC8f-jFM.js","sources":["../src/graph.ts"],"sourcesContent":["/**\n * Graph Visualization and Backlinks\n * Interactive force-directed graph based on Quartz\n */\n\nimport type { D3Config } from './graph-visual';\nimport { currentNoteSlug, resolveWithBase } from './site-context';\n\ninterface GraphNode {\n  id: string;\n  title: string;\n  type: 'essay' | 'thought' | 'doc';\n  url?: string;\n  href?: string;\n  tags?: string[];\n}\n\ninterface GraphEdge {\n  source: string;\n  target: string;\n}\n\ninterface GraphData {\n  nodes: GraphNode[];\n  edges: GraphEdge[];\n}\n\nconst defaultLocalConfig: D3Config = {\n  drag: true,\n  zoom: true,\n  depth: 1,\n  scale: 1.1,\n  repelForce: 0.5,\n  centerForce: 0.3,\n  linkDistance: 30,\n  fontSize: 0.6,\n  opacityScale: 1,\n  focusOnHover: false,\n};\n\nconst defaultGlobalConfig: D3Config = {\n  drag: true,\n  zoom: true,\n  depth: -1,\n  scale: 0.9,\n  repelForce: 0.5,\n  centerForce: 0.2,\n  linkDistance: 30,\n  fontSize: 0.6,\n  opacityScale: 1,\n  focusOnHover: true,\n};\n\nclass GraphManager {\n  private graphLib: Promise<typeof import('./graph-visual')> | null = null;\n  private graphData: GraphData | null = null;\n  private localCleanup: (() => void) | null = null;\n  private globalCleanup: (() => void) | null = null;\n  private initPromise: Promise<void> | null = null;\n\n  async init(): Promise<void> {\n    if (!this.initPromise) {\n      this.initPromise = this.initialize();\n    }\n    return this.initPromise;\n  }\n\n  private async initialize(): Promise<void> {\n    // Load graph data\n    try {\n      const response = await fetch(resolveWithBase('graph.json'));\n      if (!response.ok) {\n        console.warn('[~] Graph data not available');\n        return;\n      }\n      this.graphData = await response.json();\n      if (this.graphData) {\n        console.log('[+] Loaded graph with', this.graphData.nodes.length, 'nodes');\n      }\n    } catch (e) {\n      console.warn('[~] Failed to load graph:', e);\n      return;\n    }\n\n    this.renderBacklinks();\n    await this.initLocalGraph();\n    this.setupGlobalGraphToggle();\n    this.setupResizeHandler();\n  }\n\n  private async initLocalGraph(): Promise<void> {\n    if (!this.graphData) return;\n\n    const container = document.getElementById('graph-container');\n    if (!container) return;\n\n    const currentSlug = this.getCurrentSlug();\n    if (!currentSlug) return;\n\n    // Track visited page\n    const { addToVisited } = await this.loadGraphLib();\n    addToVisited(currentSlug);\n\n    try {\n      const { renderGraph } = await this.loadGraphLib();\n      this.localCleanup = await renderGraph(\n        container,\n        currentSlug,\n        this.graphData,\n        defaultLocalConfig,\n      );\n    } catch (e) {\n      console.error('[!] Failed to render local graph:', e);\n    }\n  }\n\n  private setupGlobalGraphToggle(): void {\n    const button = document.getElementById('global-graph-toggle');\n    const modal = document.getElementById('global-graph-outer');\n\n    if (!button || !modal) return;\n\n    button.addEventListener('click', async () => {\n      await this.showGlobalGraph();\n    });\n\n    // Close on escape\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape' && modal.classList.contains('active')) {\n        this.hideGlobalGraph();\n      }\n    });\n\n    // Close on backdrop click\n    modal.addEventListener('click', (e) => {\n      if (e.target === modal) {\n        this.hideGlobalGraph();\n      }\n    });\n  }\n\n  private async renderGlobalGraph(): Promise<void> {\n    if (!this.graphData) return;\n\n    const container = document.getElementById('global-graph-container');\n    if (!container) return;\n\n    const currentSlug = this.getCurrentSlug() || '';\n\n    try {\n      const { renderGraph } = await this.loadGraphLib();\n      this.globalCleanup = await renderGraph(\n        container,\n        currentSlug,\n        this.graphData,\n        defaultGlobalConfig,\n      );\n    } catch (e) {\n      console.error('[!] Failed to render global graph:', e);\n    }\n  }\n\n  private hideGlobalGraph(): void {\n    const modal = document.getElementById('global-graph-outer');\n    modal?.classList.remove('active');\n\n    if (this.globalCleanup) {\n      this.globalCleanup();\n      this.globalCleanup = null;\n    }\n\n    // Clean up rendered graph contents\n    const container = document.getElementById('global-graph-container');\n    if (container) {\n      container.innerHTML = '';\n    }\n  }\n\n  async showGlobalGraph(): Promise<void> {\n    await this.init();\n    const modal = document.getElementById('global-graph-outer');\n    if (!modal) return;\n    modal.classList.add('active');\n    await this.renderGlobalGraph();\n  }\n\n  private setupResizeHandler(): void {\n    let resizeTimeout: number | undefined;\n    window.addEventListener('resize', () => {\n      clearTimeout(resizeTimeout);\n      resizeTimeout = window.setTimeout(async () => {\n        // Re-render local graph on resize to handle viewport changes\n        const container = document.getElementById('graph-container');\n        if (container && container.offsetWidth > 0 && container.offsetHeight > 0) {\n          if (this.localCleanup) {\n            this.localCleanup();\n            this.localCleanup = null;\n          }\n          await this.initLocalGraph();\n        }\n      }, 100);\n    });\n  }\n\n  cleanup(): void {\n    if (this.localCleanup) {\n      this.localCleanup();\n      this.localCleanup = null;\n    }\n    if (this.globalCleanup) {\n      this.globalCleanup();\n      this.globalCleanup = null;\n    }\n  }\n\n  private renderBacklinks(): void {\n    const container = document.getElementById('backlinks');\n    if (!container || !this.graphData) return;\n\n    // Check if backlinks already exist (rendered by backend)\n    const existingList = container.querySelector('.backlinks-list');\n    if (existingList) {\n      // Backlinks already rendered by backend, skip\n      return;\n    }\n\n    const currentSlug = this.getCurrentSlug();\n    if (!currentSlug) return;\n\n    const backlinks = this.graphData.edges\n      .filter((edge) => edge.target === currentSlug)\n      .map((edge) => this.graphData!.nodes.find((n) => n.id === edge.source))\n      .filter((node): node is GraphNode => node !== undefined);\n\n    if (backlinks.length === 0) {\n      return;\n    }\n\n    const list = document.createElement('ul');\n    list.className = 'backlinks-list';\n\n    backlinks.forEach((node) => {\n      const li = document.createElement('li');\n      const link = document.createElement('a');\n      const targetPath = node.url || `${node.id}.html`;\n      link.href = resolveWithBase(targetPath).toString();\n      link.textContent = node.title;\n      li.appendChild(link);\n      list.appendChild(li);\n    });\n\n    container.appendChild(list);\n  }\n\n  private getCurrentSlug(): string | null {\n    return currentNoteSlug();\n  }\n\n  private loadGraphLib() {\n    if (!this.graphLib) {\n      this.graphLib = import('./graph-visual');\n    }\n    return this.graphLib;\n  }\n}\n\nlet graphManager: GraphManager | null = null;\n\nexport async function initGraph(): Promise<void> {\n  if (!graphManager) {\n    graphManager = new GraphManager();\n  }\n  await graphManager.init();\n}\n\nexport async function openGlobalGraph(): Promise<void> {\n  if (!graphManager) {\n    graphManager = new GraphManager();\n  }\n  await graphManager.showGlobalGraph();\n}\n\nexport type { GraphData, GraphNode, GraphEdge };\n"],"names":[],"mappings":"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"}