{"version":3,"file":"previews-C0a62L67.js","sources":["../src/previews.ts"],"sourcesContent":["/**\n * Internal Link Previews\n * Shows preview of essays/thoughts when hovering over internal links\n */\n\nimport { resolveWithBase, stripBasePath } from './site-context';\n\ninterface PreviewData {\n  title: string;\n  preview: string;\n  type: 'essay' | 'thought' | 'doc';\n  has_toc?: boolean;\n}\n\ninterface PreviewsMap {\n  [url: string]: PreviewData;\n}\n\ninterface PreviewConfig {\n  hoverDelay: number;\n  fadeoutDelay: number;\n  maxWidth: number;\n  offsetX: number;\n  offsetY: number;\n}\n\nclass LinkPreviewManager {\n  private config: PreviewConfig = {\n    hoverDelay: 500,\n    fadeoutDelay: 100,\n    maxWidth: 400,\n    offsetX: 12,\n    offsetY: 12,\n  };\n\n  private previews: PreviewsMap = {};\n  private popup: HTMLDivElement | null = null;\n  private showTimer: number | null = null;\n  private hideTimer: number | null = null;\n  private previewsLoaded = false;\n  private previewsPromise: Promise<void> | null = null;\n\n  async init(): Promise<void> {\n    this.popup = document.createElement('div');\n    this.popup.id = 'link-preview';\n    this.popup.style.display = 'none';\n    document.body.appendChild(this.popup);\n\n    // Keep popup open when hovering over it\n    this.popup.addEventListener('mouseenter', () => {\n      if (this.hideTimer !== null) clearTimeout(this.hideTimer);\n    });\n\n    this.popup.addEventListener('mouseleave', () => {\n      this.hidePreview();\n    });\n\n    // Attach hover listeners to all internal links\n    this.attachListeners();\n  }\n\n  private attachListeners(): void {\n    document.querySelectorAll<HTMLAnchorElement>('a[href$=\".html\"]').forEach(link => {\n      const href = link.getAttribute('href');\n      if (!href) return;\n      const urlKey = this.normalizeHref(href);\n      if (!urlKey) return;\n\n      link.addEventListener('mouseenter', (e) => this.onLinkHover(e, urlKey, link));\n      link.addEventListener('mouseleave', () => this.onLinkLeave());\n    });\n  }\n\n  private onLinkHover(_e: MouseEvent, urlKey: string, linkElement: HTMLAnchorElement): void {\n    // Clear any existing timers\n    if (this.hideTimer !== null) clearTimeout(this.hideTimer);\n    if (this.showTimer !== null) clearTimeout(this.showTimer);\n\n    // Set timer to show popup after delay\n    this.showTimer = window.setTimeout(async () => {\n      const ok = await this.ensurePreviewsLoaded();\n      if (!ok) return;\n      if (!this.previews[urlKey]) return;\n      this.showPreview(urlKey, linkElement);\n    }, this.config.hoverDelay);\n  }\n\n  private onLinkLeave(): void {\n    // Clear show timer\n    if (this.showTimer !== null) clearTimeout(this.showTimer);\n\n    // Hide after delay (gives time to move mouse to popup)\n    this.hideTimer = window.setTimeout(() => {\n      this.hidePreview();\n    }, 200); // Increased from fadeoutDelay to give time to reach popup\n  }\n\n  private showPreview(urlKey: string, linkElement: HTMLAnchorElement): void {\n    const data = this.previews[urlKey];\n    if (!data || !this.popup) return;\n\n    // Build popup HTML\n    const typeLabel = data.type === 'thought' ? 'Thought' :\n                      data.type === 'doc' ? 'Doc' : 'Essay';\n\n    // If preview contains TOC HTML, fix relative anchor links to point to target page\n    let previewContent: string;\n    if (data.has_toc) {\n      // Replace relative anchor hrefs (#section) with absolute links (/page.html#section)\n      const targetUrl = resolveWithBase(urlKey).pathname;\n      previewContent = data.preview.replace(/href=\"#/g, `href=\"${targetUrl}#`);\n    } else {\n      previewContent = `<p>${this.escapeHtml(data.preview)}</p>`;\n    }\n\n    this.popup.innerHTML = `\n      <div class=\"preview-header\">\n        <span class=\"preview-type\">${typeLabel}</span>\n        <span class=\"preview-title\">${this.escapeHtml(data.title)}</span>\n      </div>\n      <div class=\"preview-content\">\n        ${previewContent}\n      </div>\n    `;\n\n    // Show popup (invisible) so we can measure its dimensions\n    this.popup.style.visibility = 'hidden';\n    this.popup.style.display = 'block';\n    this.popup.style.opacity = '0';\n\n    // Position after a frame so dimensions are calculated\n    requestAnimationFrame(() => {\n      if (!this.popup) return;\n      this.positionPopupNearLink(linkElement);\n      this.popup.style.visibility = 'visible';\n\n      // Fade in\n      requestAnimationFrame(() => {\n        if (this.popup) {\n          this.popup.style.opacity = '1';\n        }\n      });\n    });\n  }\n\n  private hidePreview(): void {\n    if (!this.popup) return;\n\n    this.popup.style.opacity = '0';\n    setTimeout(() => {\n      if (this.popup) {\n        this.popup.style.display = 'none';\n      }\n    }, 200);\n  }\n\n  private positionPopupNearLink(linkElement: HTMLAnchorElement): void {\n    if (!this.popup) return;\n\n    const linkRect = linkElement.getBoundingClientRect();\n    const popupRect = this.popup.getBoundingClientRect();\n    const viewportWidth = window.innerWidth;\n    const viewportHeight = window.innerHeight;\n\n    // Try to position below and to the right of the link\n    let x = linkRect.left;\n    let y = linkRect.bottom + 8;\n\n    // If popup goes off-screen to the right, align to right edge of link\n    if (x + popupRect.width > viewportWidth - 20) {\n      x = Math.max(20, viewportWidth - popupRect.width - 20);\n    }\n\n    // If popup goes off-screen at bottom, position above the link\n    if (y + popupRect.height > viewportHeight - 20) {\n      y = linkRect.top - popupRect.height - 8;\n    }\n\n    // Ensure minimum margins\n    x = Math.max(20, x);\n    y = Math.max(20, y);\n\n    this.popup.style.left = x + 'px';\n    this.popup.style.top = y + 'px';\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  private normalizeHref(href: string): string | null {\n    try {\n      const targetUrl = resolveWithBase(href);\n      return stripBasePath(targetUrl.pathname);\n    } catch (e) {\n      return null;\n    }\n  }\n\n  private async ensurePreviewsLoaded(): Promise<boolean> {\n    if (this.previewsLoaded) return true;\n    if (!this.previewsPromise) {\n      this.previewsPromise = (async () => {\n        try {\n          const response = await fetch(resolveWithBase('previews.json'));\n          if (!response.ok) {\n            throw new Error(`HTTP ${response.status}`);\n          }\n          this.previews = await response.json();\n          this.previewsLoaded = true;\n          console.log('[+] Loaded', Object.keys(this.previews).length, 'link previews');\n        } catch (e) {\n          console.error('[-] Failed to load previews:', e);\n        }\n      })();\n    }\n\n    await this.previewsPromise;\n    return this.previewsLoaded;\n  }\n}\n\n// Singleton instance\nlet previewManager: LinkPreviewManager | null = null;\n\nexport function initPreviews(): void {\n  if (!previewManager) {\n    previewManager = new LinkPreviewManager();\n    previewManager.init().catch(console.error);\n  }\n}\n\nexport type { PreviewData, PreviewsMap };\n"],"names":[],"mappings":"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"}